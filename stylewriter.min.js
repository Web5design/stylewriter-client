var StyleWriterUtil={encode_base64:function(b){for(var c="",d,e,f,g,h,i,k=0;k<b.length;){d=b.charCodeAt(k++);e=b.charCodeAt(k++);f=b.charCodeAt(k++);g=d>>2;d=((d&3)<<4)+(e>>4);h=((e&15)<<2)+(f>>6);i=f&63;if(isNaN(e))h=i=64;else if(isNaN(f))i=64;c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)}return c},
decompressRLE:function(b){var c=b.split("|");b=[];for(var d=0;d<c.length;d++){a=c[d].split(":");l=parseInt(a[0],10);if(a.length===1)for(j=0;j<l;j++)b.push(false);else for(j=0;j<l;j++)b.push(a[1])}c=[];for(d=0;d<64;d++)c[d]=b.splice(0,64);return c},makeEvent:function(b){return{target:b.target||b.srcElement,pX:b.pageX||b.clientX,pY:b.pageY||b.clientY,evt:b}},fString:function(b){if(b){b=b.split("/").slice(-4).join("_").replace(/=/g,"_").split(".");b.pop();return b.pop()}}};
OpenLayers.Control.StyleWriterInteraction=OpenLayers.Class(OpenLayers.Control,{format:null,handlerOptions:null,handlers:null,hoverRequest:null,archive:{},tileRes:4,initialize:function(b){b=b||{};b.handlerOptions=b.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[b||{}]);this.format=new OpenLayers.Format.GeoJSON;this.handlers={hover:new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:$.browser.msie?
40:10})),click:new OpenLayers.Handler.Click(this,{click:this.getInfoForClick})};this.callbacks={out:StyleWriterTooltips.unselect,over:StyleWriterTooltips.select,click:StyleWriterTooltips.click}},setMap:function(b){this.handlers.hover.setMap(b);this.handlers.click.setMap(b);OpenLayers.Control.prototype.setMap.apply(this,arguments);this.activate()},activate:function(){if(!this.active){this.handlers.hover.activate();this.handlers.click.activate()}return OpenLayers.Control.prototype.activate.apply(this,
arguments)},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},getGridFeature:function(b,c){var d=this.archive[StyleWriterUtil.fString(c.url)];if(d!==true){var e=[Math.floor((b.pX-$(c.imgDiv).offset().left)/this.tileRes),Math.floor((b.pY-$(c.imgDiv).offset().top)/this.tileRes)];return c.layer.options.keymap[d[e[1]]&&d[e[1]][e[0]]]}},getPointFeature:function(b,c){var d=this.archive[StyleWriterUtil.fString(c.url)],e=this.map.getLonLatFromPixel(b.evt.xy);e.transform(new OpenLayers.Projection("EPSG:900913"),
new OpenLayers.Projection("EPSG:4326"));e=new OpenLayers.Geometry.Point(e.lon,e.lat);for(var f=0;f<d.length;f++)if(d[f].geometry.containsPoint(e)){d=d[f].attributes;d.description=d[c.layer.options.value_field];d.name=d[c.layer.options.name_field];return d}},getTileStack:function(b,c){for(var d=false,e={},f=[],g=0;g<b[0].grid.length&&!d;g++)for(var h=0;h<b[0].grid[g].length&&!d;h++){d=$(b[0].grid[g][h].imgDiv).offset();if(d=d.top<c.pY&&d.top+256>c.pY&&d.left<c.pX&&d.left+256>c.pX)e={x:g,y:h}}if(d)for(g=
0;g<b.length;g++)b[g].grid[e.x]&&b[g].grid[e.x][e.y]&&f.push(b[g].grid[e.x][e.y]);return f},tileDataUrl:function(b){return b.layer.options.symbolizer==="point"?b.url.replace("png","json"):b.url.replace("png",StyleWriterUtil.encode_base64(b.layer.options.join_field)+".grid.json")},reqTile:function(b){return $.jsonp({url:this.tileDataUrl(b),context:this,success:this.readDone,error:function(){},callback:StyleWriterUtil.fString(b.url),callbackParameter:"callback"})},viableLayers:function(){var b=this.map.getLayersBy("isBaseLayer",
false);return $(b).filter(function(c){return b[c].visibility===true&&b[c].CLASS_NAME==="OpenLayers.Layer.StyleWriter"})},getInfoForClick:function(b){this.viableLayers();b=StyleWriterUtil.makeEvent(b);var c=this.getTileStack(this.viableLayers(),b),d=null;this.target=b.target;for(var e=0;e<c.length;e++)if(this.archive[StyleWriterUtil.fString(c[e].url)])(d=c[e].layer.options.symbolizer=="polygon"?this.getGridFeature(b,c[e]):this.getPointFeature(b,c[e]))&&this.callbacks.click(d,c[e].layer)},getInfoForHover:function(b){this.viableLayers();
b=StyleWriterUtil.makeEvent(b);var c=this.getTileStack(this.viableLayers(),b),d=null;this.target=b.target;for(var e=0;e<c.length;e++){d=StyleWriterUtil.fString(c[e].url);if(this.archive[d])if(d=c[e].layer.options.symbolizer=="polygon"?this.getGridFeature(b,c[e]):this.getPointFeature(b,c[e])){if(d!==this.feature){this.feature=d;this.callbacks.out(d,c[e].layer,b);d&&this.callbacks.over(d,c[e].layer,b)}}else{this.callbacks.out(d,c[e].layer,b);this.feature=null}else{this.callbacks.out({},c[e].layer);
if(!this.archive[d])try{this.archive[d]=true;this.target.hoverRequest=this.reqTile(c[e])}catch(f){this.archive[d]=false}}}},readDone:function(b){this.archive[b.code_string]=typeof b.features==="string"?StyleWriterUtil.decompressRLE(b.features):this.format.read(b.features)},CLASS_NAME:"OpenLayers.Control.StyleWriterInteraction"});OpenLayers.Layer.StyleWriter=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:false,sphericalMercator:true,urlsafe_encode_base64:function(b){return this.encode_base64(b).replace("/","_").replace("+","-")},encode_base64:function(b){for(var c="",d,e,f,g,h,i,k=0;k<b.length;){d=b.charCodeAt(k++);e=b.charCodeAt(k++);f=b.charCodeAt(k++);g=d>>2;d=((d&3)<<4)+(e>>4);h=((e&15)<<2)+(f>>6);i=f&63;if(isNaN(e))h=i=64;else if(isNaN(f))i=64;c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)}return c},initialize:function(b,c,d){if(d&&d.sphericalMercator||this.sphericalMercator)d=OpenLayers.Util.extend({maxExtent:new OpenLayers.Bounds(-2.00375083392E7,-2.00375083392E7,2.00375083392E7,2.00375083392E7),maxResolution:156543.0339,numZoomLevels:19,units:"m",projection:"EPSG:900913"},
d);c=c||this.url;b=b||this.name;OpenLayers.Layer.Grid.prototype.initialize.apply(this,[b,c,{},d])},clone:function(b){if(b==null)b=new OpenLayers.Layer.StyleWriter(this.name,this.url,this.getOptions());b=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[b]);if(this.tileSize!=null)b.tileSize=this.tileSize.clone();b.grid=[];return b},getURL:function(b){var c=this.map.getResolution(),d=Math.round((b.left-this.maxExtent.left)/(c*this.tileSize.w));b=Math.round((this.maxExtent.top-b.top)/(c*this.tileSize.h));
c=this.map.getZoom();var e=this.url,f=""+d+b+c;c+=this.minzoom!=null?parseInt(this.minzoom):0;e=e instanceof Array?this.selectUrl(f,e):e;return OpenLayers.String.format(e,{mapfile:this.urlsafe_encode_base64(this.mapfile),x:d,y:b,z:c,format:"png"})},addTile:function(b,c){return new OpenLayers.Tile.Image(this,c,b,null,this.tileSize)},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);if(!this.tileOrigin)this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.bottom)},
CLASS_NAME:"OpenLayers.Layer.StyleWriter"});StyleWriterTooltips={};StyleWriterTooltips.click=function(b){var c="";if(b.name)c+=b.name;if(b.description)c+=b.description;var d;if($(c).is("a"))d=$(c);else if($(c).children("a").size()>0)d=$(c).children("a")[0];if(d){b=$(d).attr("href");window.location=b;return false}};
StyleWriterTooltips.getToolTip=function(b){var c="<div class='openlayers-tooltip'>";if(b.name)c+="<div class='openlayers-tooltip-name'>"+b.name+"</div>";if(b.description)c+="<div class='openlayers-tooltip-description'>"+b.description+"</div>";c+="</div>";return $(c)};StyleWriterTooltips.select=function(b,c){var d=StyleWriterTooltips.getToolTip(b);$(c.map.div).css("cursor","pointer");$(d).data("layername",c.name);$(c.map.div).append(d)};
StyleWriterTooltips.positionedSelect=function(b){b=StyleWriterTooltips.getToolTip(b);$("body").append(b)};StyleWriterTooltips.unselect=function(b,c){$(c.map.div).css("cursor","default");$(c.map.div).children("div.openlayers-tooltip").filter(function(){return $(this).data("layername")==c.name}).fadeOut("fast",function(){$(this).remove()})};
