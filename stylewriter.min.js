(function(b,d){function c(){}function e(f){y=[f]}function h(f,r,s){return f&&f.apply(r.context||r,s)}function i(f){function r(g){!t++&&d(function(){v();w&&(z[m]={s:[g]});E&&(g=E.apply(f,[g]));h(f.success,f,[g,F]);h(G,f,[f,F])},0)}function s(g){!t++&&d(function(){v();w&&g!=H&&(z[m]=g);h(f.error,f,[f,g]);h(G,f,[f,g])},0)}f=b.extend({},I,f);var G=f.complete,E=f.dataFilter,J=f.callbackParameter,K=f.callback,V=f.cache,w=f.pageCache,L=f.charset,m=f.url,p=f.data,M=f.timeout,x,t=0,v=c;f.abort=function(){!t++&&
v()};if(h(f.beforeSend,f,[f])===false||t)return f;m=m||n;p=p?typeof p=="string"?p:b.param(p,f.traditional):n;m+=p?(/\?/.test(m)?"&":"?")+p:n;J&&(m+=(/\?/.test(m)?"&":"?")+encodeURIComponent(J)+"=?");!V&&!w&&(m+=(/\?/.test(m)?"&":"?")+"_"+(new Date).getTime()+"=");m=m.replace(/=\?(&|$)/,"="+K+"$1");w&&(x=z[m])?x.s?r(x.s[0]):s(x):d(function(g,u,A){if(!t){A=M>0&&d(function(){s(H)},M);v=function(){A&&clearTimeout(A);g[N]=g[B]=g[O]=g[C]=null;q[P](g);u&&q[P](u)};window[K]=e;g=b(Q)[0];g.id=R+W++;if(L)g[o]=
L;var T=function(D){(g[B]||c)();D=y;y=undefined;D?r(D[0]):s(S)};if(U.msie){g.event=B;g.htmlFor=g.id;g[N]=function(){/loaded|complete/.test(g.readyState)&&T()}}else{g[C]=g[O]=T;U.opera?(u=b(Q)[0]).text="jQuery('#"+g.id+"')[0]."+C+"()":g[k]=k}g.src=m;q.insertBefore(g,q.firstChild);u&&q.insertBefore(u,q.firstChild)}},0);return f}var k="async",o="charset",n="",S="error",R="_jqjsp",B="onclick",C="on"+S,O="onload",N="onreadystatechange",P="removeChild",Q="<script/>",F="success",H="timeout",U=b.browser,
q=b("head")[0]||document.documentElement,z={},W=0,y,I={callback:R,url:location.href};i.setup=function(f){b.extend(I,f)};b.jsonp=i})(jQuery,setTimeout);
var StyleWriterUtil={encode_base64:function(b){for(var d="",c,e,h,i,k,o,n=0;n<b.length;){c=b.charCodeAt(n++);e=b.charCodeAt(n++);h=b.charCodeAt(n++);i=c>>2;c=((c&3)<<4)+(e>>4);k=((e&15)<<2)+(h>>6);o=h&63;if(isNaN(e))k=o=64;else if(isNaN(h))o=64;d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(k)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(o)}return d},
decompressRLE:function(b){var d=b.split("|");b=[];for(var c=0;c<d.length;c++){a=d[c].split(":");l=parseInt(a[0],10);if(a.length===1)for(j=0;j<l;j++)b.push(false);else for(j=0;j<l;j++)b.push(a[1])}d=[];for(c=0;c<64;c++)d[c]=b.splice(0,64);return d},makeEvent:function(b){return{target:b.target||b.srcElement,pX:b.pageX||b.clientX,pY:b.pageY||b.clientY,evt:b}},fString:function(b){if(b){b=b.split("/").slice(-4).join("_").replace(/=/g,"_").split(".");b.pop();return b.pop()}}};
OpenLayers.Control.StyleWriterInteraction=OpenLayers.Class(OpenLayers.Control,{feature:{},format:null,handlerOptions:null,handlers:null,hoverRequest:null,archive:{},tileRes:4,initialize:function(b){b=b||{};b.handlerOptions=b.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[b||{}]);this.format=new OpenLayers.Format.GeoJSON;this.handlers={hover:new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||
{},{delay:$.browser.msie?40:10})),click:new OpenLayers.Handler.Click(this,{click:this.getInfoForClick})};this.callbacks={out:StyleWriterTooltips.unselect,over:StyleWriterTooltips.select,click:StyleWriterTooltips.click}},setMap:function(b){this.handlers.hover.setMap(b);this.handlers.click.setMap(b);OpenLayers.Control.prototype.setMap.apply(this,arguments);this.activate();var d=this;b.events.on({addlayer:function(c){c.layer.CLASS_NAME==="OpenLayers.Layer.StyleWriter"&&typeof c.layer.keymap==="string"&&
d.loadKeymap(c.layer)}})},activate:function(){if(!this.active){this.handlers.hover.activate();this.handlers.click.activate()}return OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)},getGridFeature:function(b,d){var c=this.archive[StyleWriterUtil.fString(d.url)];if(c!==true){var e=[Math.floor((b.pX-$(d.imgDiv).offset().left)/this.tileRes),Math.floor((b.pY-$(d.imgDiv).offset().top)/this.tileRes)];
return d.layer.options.keymap[c[e[1]]&&c[e[1]][e[0]]]}},getPointFeature:function(b,d){var c=this.archive[StyleWriterUtil.fString(d.url)],e=this.map.getLonLatFromPixel(b.evt.xy);e.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));e=new OpenLayers.Geometry.Point(e.lon,e.lat);for(var h=0;h<c.length;h++)if(c[h].geometry.containsPoint(e)){c=c[h].attributes;c.description=c[d.layer.options.value_field];c.name=c[d.layer.options.name_field];return c}},getTileStack:function(b,
d){for(var c=false,e={},h=[],i=0;i<b[0].grid.length&&!c;i++)for(var k=0;k<b[0].grid[i].length&&!c;k++){c=$(b[0].grid[i][k].imgDiv).offset();if(c=c.top<d.pY&&c.top+256>d.pY&&c.left<d.pX&&c.left+256>d.pX)e={x:i,y:k}}if(c)for(i=0;i<b.length;i++)b[i].grid[e.x]&&b[i].grid[e.x][e.y]&&h.push(b[i].grid[e.x][e.y]);return h},tileDataUrl:function(b){return b.layer.options.symbolizer==="point"?b.url.replace("png","json"):b.url.replace("png",StyleWriterUtil.encode_base64(b.layer.options.join_field)+".grid.json")},
reqTile:function(b){return $.jsonp({url:this.tileDataUrl(b),context:this,success:this.readDone,error:function(){},callback:StyleWriterUtil.fString(b.url),callbackParameter:"callback"})},viableLayers:function(){var b=this.map.getLayersBy("isBaseLayer",false);return $(b).filter(function(d){return b[d].visibility===true&&b[d].CLASS_NAME==="OpenLayers.Layer.StyleWriter"})},getInfoForClick:function(b){this.viableLayers();b=StyleWriterUtil.makeEvent(b);var d=this.getTileStack(this.viableLayers(),b),c=null;
this.target=b.target;for(var e=0;e<d.length;e++)if(this.archive[StyleWriterUtil.fString(d[e].url)])(c=d[e].layer.options.symbolizer=="polygon"?this.getGridFeature(b,d[e]):this.getPointFeature(b,d[e]))&&this.callbacks.click(c,d[e].layer)},getInfoForHover:function(b){this.viableLayers();b=StyleWriterUtil.makeEvent(b);var d=this.getTileStack(this.viableLayers(),b),c=null;this.target=b.target;for(var e=0;e<d.length;e++){c=StyleWriterUtil.fString(d[e].url);if(this.archive[c])if(c=d[e].layer.options.symbolizer==
"polygon"?this.getGridFeature(b,d[e]):this.getPointFeature(b,d[e])){if(c!==this.feature[e]){this.feature[e]=c;this.callbacks.out(c,d[e].layer,b);c&&this.callbacks.over(c,d[e].layer,b)}}else{this.callbacks.out(c,d[e].layer,b);this.feature[e]=null}else{this.callbacks.out({},d[e].layer);this.feature[e]=null;if(!this.archive[c])try{this.archive[c]=true;this.target.hoverRequest=this.reqTile(d[e])}catch(h){this.archive[c]=false}}}},readDone:function(b){this.archive[b.code_string]=typeof b.features==="string"?
StyleWriterUtil.decompressRLE(b.features):this.format.read(b.features)},loadKeymap:function(b){$.jsonp({url:b.keymap,context:this,success:function(d){if(typeof d!=="undefined")b.keymap=b.options.keymap=d},error:function(){},callback:"keymapCallback"})},CLASS_NAME:"OpenLayers.Control.StyleWriterInteraction"});StyleWriterTooltips={};
StyleWriterTooltips.click=function(b){var d="";if(b.name)d+=b.name;if(b.description)d+=b.description;var c;if($(d).is("a"))c=$(d);else if($(d).children("a").size()>0)c=$(d).children("a")[0];if(c){b=$(c).attr("href");window.location=b;return false}};
StyleWriterTooltips.getToolTip=function(b,d,c){var e=$("div.openlayers-tooltip-"+c+":not(.removed)",$(d));if(e.size()===0){e=$("<div class='openlayers-tooltip openlayers-tooltip-"+c+"'><div class='openlayers-tooltip-name'></div><div class='openlayers-tooltip-description'></div></div>");$(d).append(e)}$("div.openlayers-tooltip-name",e).html(b.name||"");$("div.openlayers-tooltip-description",e).html(b.description||"");for(b=c-1;b>0;b--){d=$("div.openlayers-tooltip-"+b+":not(.removed)");d.size()>0&&
d.addClass("hidden").hide()}return e};StyleWriterTooltips.select=function(b,d){var c=$.inArray(d,d.map.layers);StyleWriterTooltips.getToolTip(b,d.map.div,c);$(d.map.div).css("cursor","pointer")};
StyleWriterTooltips.unselect=function(b,d){var c=$.inArray(d,d.map.layers);$(d.map.div).css("cursor","default");$(d.map.div).children("div.openlayers-tooltip-"+c).addClass("removed").fadeOut("fast",function(){$(this).remove()});for(c=c-1;c>0;c--){var e=$("div.openlayers-tooltip-"+c+":not(.removed)");if(e.size()>0){e.removeClass("hidden").show();break}}};
OpenLayers.Layer.StyleWriter=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:false,sphericalMercator:true,urlsafe_encode_base64:function(b){return this.encode_base64(b).replace("/","_").replace("+","-")},encode_base64:function(b){for(var d="",c,e,h,i,k,o,n=0;n<b.length;){c=b.charCodeAt(n++);e=b.charCodeAt(n++);h=b.charCodeAt(n++);i=c>>2;c=((c&3)<<4)+(e>>4);k=((e&15)<<2)+(h>>6);o=h&63;if(isNaN(e))k=o=64;else if(isNaN(h))o=64;d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(k)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(o)}return d},initialize:function(b,d,c){if(c&&c.sphericalMercator||this.sphericalMercator)c=OpenLayers.Util.extend({maxExtent:new OpenLayers.Bounds(-2.00375083392E7,-2.00375083392E7,2.00375083392E7,2.00375083392E7),maxResolution:156543.0339,numZoomLevels:19,units:"m",projection:"EPSG:900913"},
c);d=d||this.url;b=b||this.name;OpenLayers.Layer.Grid.prototype.initialize.apply(this,[b,d,{},c])},clone:function(b){if(b==null)b=new OpenLayers.Layer.StyleWriter(this.name,this.url,this.getOptions());b=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[b]);if(this.tileSize!=null)b.tileSize=this.tileSize.clone();b.grid=[];return b},getURL:function(b){var d=this.map.getResolution(),c=Math.round((b.left-this.maxExtent.left)/(d*this.tileSize.w));b=Math.round((this.maxExtent.top-b.top)/(d*this.tileSize.h));
d=this.map.getZoom();var e=this.url,h=""+c+b+d;d+=this.minzoom!=null?parseInt(this.minzoom):0;e=e instanceof Array?this.selectUrl(h,e):e;return OpenLayers.String.format(e,{mapfile:this.urlsafe_encode_base64(this.mapfile),x:c,y:b,z:d,format:"png"})},addTile:function(b,d){return new OpenLayers.Tile.Image(this,d,b,null,this.tileSize)},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);if(!this.tileOrigin)this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.bottom)},
CLASS_NAME:"OpenLayers.Layer.StyleWriter"});